rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the quiz
    function isOwner(quizId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/quizzes/$(quizId)).data.ownerId == request.auth.uid;
    }

    // Quizzes collection
    match /quizzes/{quizId} {
      // Allow anyone to read published quizzes
      allow read: if resource.data.isPublished == true ||
                     (isAuthenticated() && resource.data.ownerId == request.auth.uid);

      // Allow authenticated users to create quizzes
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid;

      // Allow anyone to update stats on published quizzes (for view/completion tracking)
      allow update: if resource.data.isPublished == true &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats']);

      // Allow owners to update their quizzes
      allow update: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid &&
                       request.resource.data.ownerId == request.auth.uid;

      // Allow owners to delete their quizzes
      allow delete: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;
    }

    // Leads/submissions collection (Legacy?)
    match /submissions/{submissionId} {
      allow read: if isAuthenticated();
      allow create: if true;
      allow read: if isAuthenticated() && isOwner(resource.data.quizId);
    }

    // Quiz Attempts (Analytics)
    match /quiz_attempts/{attemptId} {
      // Allow anyone to start/update an attempt (public quiz taking)
      allow create, update: if true;

      // Allow only the quiz owner to view the analytics/leads
      allow read: if isOwner(resource.data.quizId);
    }
  }
}
